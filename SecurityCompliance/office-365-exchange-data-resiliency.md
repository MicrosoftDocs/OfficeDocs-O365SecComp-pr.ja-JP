---
title: Office 365 Exchange データの復元
ms.author: robmazz
author: robmazz
manager: laurawi
audience: ITPro
ms.topic: article
ms.service: O365-seccomp
localization_priority: Normal
search.appverid:
- MET150
ms.collection:
- Strat_O365_IP
- M365-security-compliance
description: Exchange Online および Office 365 内のデータの復元のさまざまな側面について説明します。
ms.openlocfilehash: 9e61efaf95d466fcb268e12317c7feab0701c062
ms.sourcegitcommit: 1261a37c414111f869df5791548a768d853fda60
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 03/30/2019
ms.locfileid: "31004234"
---
# <a name="exchange-online-data-resiliency-in-office-365"></a><span data-ttu-id="50e58-103">Office 365 の Exchange Online データの復元</span><span class="sxs-lookup"><span data-stu-id="50e58-103">Exchange Online Data Resiliency in Office 365</span></span>

## <a name="introduction"></a><span data-ttu-id="50e58-104">概要</span><span class="sxs-lookup"><span data-stu-id="50e58-104">Introduction</span></span>
<span data-ttu-id="50e58-105">Exchange データベースに影響を与える可能性がある破損には、次の2種類があります。物理的な破損は、通常、ハードウェア (特にストレージハードウェア) の問題、およびその他の要因によって発生する論理的な破損に起因します。</span><span class="sxs-lookup"><span data-stu-id="50e58-105">There are two types of corruption that can affect an Exchange database: physical corruption, which is typically caused by hardware (in particular, storage hardware) problems, and logical corruption, which occurs due to other factors.</span></span> <span data-ttu-id="50e58-106">通常、Exchange データベース内で発生する可能性がある論理的な破損には、次の2種類があります。</span><span class="sxs-lookup"><span data-stu-id="50e58-106">Generally, there are two types of logical corruption that can occur within an Exchange database:</span></span> 
- <span data-ttu-id="50e58-107">**データベースの論理破損**-データベースページのチェックサムは一致しますが、ページ上のデータが論理的に間違っています。</span><span class="sxs-lookup"><span data-stu-id="50e58-107">**Database logical corruption** - The database page checksum matches, but the data on the page is wrong logically.</span></span> <span data-ttu-id="50e58-108">これは、データベースエンジン (拡張記憶エンジン (ESE)) がデータベースページを作成しようとしたときに、オペレーティングシステムが成功メッセージを返した場合、データがディスクに書き込まれていないか、または正しくない場所に書き込まれている場合に発生する可能性があります。</span><span class="sxs-lookup"><span data-stu-id="50e58-108">This can occur when the database engine (the Extensible Storage Engine (ESE)) attempts to write a database page and even though the operating system returns a success message, the data is either never written to the disk or it's written to the wrong place.</span></span> <span data-ttu-id="50e58-109">これは、*ロスト フラッシュ*と呼ばれます。</span><span class="sxs-lookup"><span data-stu-id="50e58-109">This is referred to as a *lost flush*.</span></span> <span data-ttu-id="50e58-110">ESE には、データベースやその他のデータ損失シナリオの物理的な破損を防止するために設計されたさまざまな機能と安全対策が用意されています。</span><span class="sxs-lookup"><span data-stu-id="50e58-110">ESE includes numerous features and safeguards that are designed to prevent physical corruption of a database and other data loss scenarios.</span></span> <span data-ttu-id="50e58-111">失われたデータを失わないようにするため、ESE にはデータベース内の失われたフラッシュ検出メカニズムと機能 (単一ページ復元) が含まれています。</span><span class="sxs-lookup"><span data-stu-id="50e58-111">To prevent lost flushes from losing data, ESE includes a lost flush detection mechanism in the database along with a feature (single page restore) to correct it.</span></span> 
- <span data-ttu-id="50e58-112">**ストレージの論理破損**-ユーザーが期待できない方法でデータが追加、削除、または操作されます。</span><span class="sxs-lookup"><span data-stu-id="50e58-112">**Store logical corruption** - Data is added, deleted, or manipulated in a way that the user doesn't expect.</span></span> <span data-ttu-id="50e58-113">これらの場合は通常、サード パーティ製のアプリケーションによって引き起こされます。</span><span class="sxs-lookup"><span data-stu-id="50e58-113">These cases are generally caused by third-party applications.</span></span> <span data-ttu-id="50e58-114">これは通常、ユーザーの観点から見た意味での破損にすぎません。</span><span class="sxs-lookup"><span data-stu-id="50e58-114">It's generally only corruption in the sense that the user views it as corruption.</span></span> <span data-ttu-id="50e58-115">Exchange ストアは、論理的破損を引き起こすトランザクションを一連の有効な MAPI 操作として見なします。</span><span class="sxs-lookup"><span data-stu-id="50e58-115">The Exchange store considers the transaction that produced the logical corruption to be a series of valid MAPI operations.</span></span> <span data-ttu-id="50e58-116">Exchange Online の[インプレース保持](https://docs.microsoft.com/exchange/security-and-compliance/create-or-remove-in-place-holds)機能により、ストアの論理的破損を防止できます (ユーザーまたはアプリケーションによってコンテンツが完全に削除されることはないため)。</span><span class="sxs-lookup"><span data-stu-id="50e58-116">The [In-Place Hold](https://docs.microsoft.com/exchange/security-and-compliance/create-or-remove-in-place-holds) features in Exchange Online provides protection from store logical corruption (because it prevents content from being permanently deleted by a user or an application).</span></span> 

<span data-ttu-id="50e58-117">Exchange Online は、ログ検査およびログ再生の両方で、レプリケートされたログファイルに対して複数の整合性チェックを実行します。</span><span class="sxs-lookup"><span data-stu-id="50e58-117">Exchange Online performs several consistency checks on replicated log files during both log inspection and log replay.</span></span> <span data-ttu-id="50e58-118">これらの整合性チェックによって、システムによって物理的破損がレプリケートされるのを防ぐことができます。</span><span class="sxs-lookup"><span data-stu-id="50e58-118">These consistency checks prevent physical corruption from being replicated by the system.</span></span> <span data-ttu-id="50e58-119">たとえば、ログ検査時には、ログファイルを検証し、ログファイルに記録されたチェックサムがメモリに生成されたチェックサムと一致することを確認する物理的な整合性チェックがあります。</span><span class="sxs-lookup"><span data-stu-id="50e58-119">For example, during log inspection, there is a physical integrity check which verifies the log file and validates that the checksum recorded in the log file matches the checksum generated in memory.</span></span> <span data-ttu-id="50e58-120">さらに、ログヘッダーに記録されたログファイルの署名がログファイルの内容と一致することを確認するために、ログファイルヘッダーが検査されます。</span><span class="sxs-lookup"><span data-stu-id="50e58-120">In addition, the log file header is examined to make sure the log file signature recorded in the log header matches that of the log file.</span></span> <span data-ttu-id="50e58-121">ログ再生中に、ログファイルはさらに精査されます。</span><span class="sxs-lookup"><span data-stu-id="50e58-121">During log replay, the log file undergoes further scrutiny.</span></span> <span data-ttu-id="50e58-122">たとえば、データベースヘッダーには、ログファイルの署名と比較して、一致していることを確認するためのログ署名も含まれています。</span><span class="sxs-lookup"><span data-stu-id="50e58-122">For example, the database header also contains the log signature which is compared with the log file's signature to ensure they match.</span></span> 

<span data-ttu-id="50e58-123">exchange Online のメールボックスデータの破損からの保護は、exchange ネイティブデータ保護を使用することによって実現され、複数のサーバーと複数のデータセンター間でアプリケーションレベルのレプリケーションを活用する復元戦略と、他の破損またはその他の理由によりデータが失われないように保護するための機能。</span><span class="sxs-lookup"><span data-stu-id="50e58-123">Protection against corruption of mailbox data in Exchange Online is achieved by using Exchange Native Data Protection, a resiliency strategy that leverages application-level replication across multiple servers and multiple datacenters along with other features that help protect data from being lost due to corruption or other reasons.</span></span> <span data-ttu-id="50e58-124">これらの機能には、次のような Microsoft または Exchange Online アプリケーション自体によって管理されるネイティブ機能が含まれます。</span><span class="sxs-lookup"><span data-stu-id="50e58-124">These features include native features that are managed by Microsoft or the Exchange Online application itself, such as:</span></span>

- [<span data-ttu-id="50e58-125">データ可用性グループ</span><span class="sxs-lookup"><span data-stu-id="50e58-125">Data Availability Groups</span></span>](https://docs.microsoft.com/exchange/back-up-email)
- <span data-ttu-id="50e58-126">シングルビット修正</span><span class="sxs-lookup"><span data-stu-id="50e58-126">Single Bit Correction</span></span> 
- <span data-ttu-id="50e58-127">オンラインデータベーススキャン</span><span class="sxs-lookup"><span data-stu-id="50e58-127">Online Database Scanning</span></span> 
- <span data-ttu-id="50e58-128">失われたフラッシュの検出</span><span class="sxs-lookup"><span data-stu-id="50e58-128">Lost Flush Detection</span></span> 
- <span data-ttu-id="50e58-129">単一ページの復元</span><span class="sxs-lookup"><span data-stu-id="50e58-129">Single Page Restore</span></span> 
- <span data-ttu-id="50e58-130">メールボックスレプリケーションサービス</span><span class="sxs-lookup"><span data-stu-id="50e58-130">Mailbox Replication Service</span></span> 
- <span data-ttu-id="50e58-131">ログファイルのチェック</span><span class="sxs-lookup"><span data-stu-id="50e58-131">Log File Checks</span></span> 
- <span data-ttu-id="50e58-132">弾性ファイルシステムへの展開</span><span class="sxs-lookup"><span data-stu-id="50e58-132">Deployment on Resilient File System</span></span> 

<span data-ttu-id="50e58-133">上記のネイティブ機能の詳細については、上記のハイパーリンクをクリックしてください。詳細については、以下を参照してください。また、ハイパーリンクのないアイテムについても説明します。</span><span class="sxs-lookup"><span data-stu-id="50e58-133">For more information on the native features listed above, click on the above hyperlinks, and see below for additional information and for details on items without hyperlinks.</span></span> <span data-ttu-id="50e58-134">これらのネイティブ機能に加えて、Exchange Online には、お客様が管理できるデータ復元機能もあります。次のようなものがあります。</span><span class="sxs-lookup"><span data-stu-id="50e58-134">In addition to these native features, Exchange Online also includes data resiliency features that customers can manage, such as:</span></span> 
- [<span data-ttu-id="50e58-135">単一アイテムの回復 (既定では有効)</span><span class="sxs-lookup"><span data-stu-id="50e58-135">Single Item Recovery (enabled by default)</span></span>](https://docs.microsoft.com/exchange/recipients-in-exchange-online/manage-user-mailboxes/recover-deleted-messages) 
- [<span data-ttu-id="50e58-136">インプレース保持と訴訟ホールド</span><span class="sxs-lookup"><span data-stu-id="50e58-136">In-Place Hold and Litigation Hold</span></span>](https://docs.microsoft.com/exchange/security-and-compliance/in-place-and-litigation-holds) 
- [<span data-ttu-id="50e58-137">削除済みアイテムの保存期間と回復可能な削除によるメールボックス (既定で有効)</span><span class="sxs-lookup"><span data-stu-id="50e58-137">Deleted Item Retention and Soft-Deleted Mailboxes (both enabled by default)</span></span>](https://docs.microsoft.com/exchange/recipients-in-exchange-online/delete-or-restore-mailboxes) 

## <a name="database-availability-groups"></a><span data-ttu-id="50e58-138">データベース可用性グループ</span><span class="sxs-lookup"><span data-stu-id="50e58-138">Database Availability Groups</span></span> 
<span data-ttu-id="50e58-139">Office 365 のすべてのメールボックスデータベースは、[データベース可用性グループ (DAG)](https://docs.microsoft.com/exchange/back-up-email)でホストされ、同じ地域内の地理的に離れた複数のデータセンターにレプリケートされます。</span><span class="sxs-lookup"><span data-stu-id="50e58-139">Every mailbox database in Office 365 is hosted in a [database availability group (DAG)](https://docs.microsoft.com/exchange/back-up-email) and replicated to geographically-separate datacenters within the same region.</span></span> <span data-ttu-id="50e58-140">最も一般的な構成は、4つのデータセンター内の4つのデータベースコピーです。ただし、地域によっては、データセンターの数が少ない (インドの3つのデータセンターにデータベースがレプリケートされ、オーストラリアと日本では2つのデータセンターにレプリケートされる) 場合があります。</span><span class="sxs-lookup"><span data-stu-id="50e58-140">The most common configuration is four database copies in four datacenters; however, some regions have fewer datacenters (databases are replicated to three datacenters in India, and two datacenters in Australia and Japan).</span></span> <span data-ttu-id="50e58-141">ただし、すべてのメールボックスデータベースには、複数のデータセンターに分散された4つのコピーがあるため、メールボックスのデータがソフトウェア、ハードウェア、およびデータセンターの障害から保護されています。</span><span class="sxs-lookup"><span data-stu-id="50e58-141">But in all cases, every mailbox database has four copies that are distributed across multiple datacenters, thereby ensuring that mailbox data is protected from software, hardware, and even datacenter failures.</span></span> 

<span data-ttu-id="50e58-142">これらの4つのコピーのうち3つは高可用性として構成されています。</span><span class="sxs-lookup"><span data-stu-id="50e58-142">Out of these four copies, three of them are configured as highly available.</span></span> <span data-ttu-id="50e58-143">4番目のコピーは、[時間差データベースコピー](https://docs.microsoft.com/Exchange/high-availability/manage-ha/activate-lagged-db-copies)として構成されます。</span><span class="sxs-lookup"><span data-stu-id="50e58-143">The fourth copy is configured as a [lagged database copy](https://docs.microsoft.com/Exchange/high-availability/manage-ha/activate-lagged-db-copies).</span></span> <span data-ttu-id="50e58-144">時間差データベースコピーは、個々のメールボックスの回復またはメールボックスのアイテムの回復を目的としたものではありません。</span><span class="sxs-lookup"><span data-stu-id="50e58-144">The lagged database copy is not intended for individual mailbox recovery or mailbox item recovery.</span></span> <span data-ttu-id="50e58-145">この目的は、システム全体に重大な致命的な破損が発生した場合に備えて回復メカニズムを提供することです。</span><span class="sxs-lookup"><span data-stu-id="50e58-145">Its purpose is to provide a recovery mechanism for the rare event of system-wide, catastrophic logical corruption.</span></span> 

<span data-ttu-id="50e58-146">Exchange Online の時間差データベースコピーは、7日間のログファイル再生ラグタイムで構成されます。</span><span class="sxs-lookup"><span data-stu-id="50e58-146">Lagged database copies in Exchange Online are configured with a seven-day log file replay lag time.</span></span> <span data-ttu-id="50e58-147">さらに、Exchange 再生ラグマネージャーは、時間差コピーに対して動的ログファイルの再生を有効にして、時間差データベースコピーを自己修復し、ログファイルの拡張を管理できるようにします。</span><span class="sxs-lookup"><span data-stu-id="50e58-147">In addition, the Exchange Replay Lag Manager is enabled to provide dynamic log file play down for lagged copies to allow lagged database copies to self-repair and manage log file growth.</span></span> <span data-ttu-id="50e58-148">Exchange Online では時間差データベースコピーが使用されていますが、ポイントインタイムのバックアップが保証されているわけではないことを理解しておくことが重要です。</span><span class="sxs-lookup"><span data-stu-id="50e58-148">Although lagged database copies are used in Exchange Online, it is important to understand that they are not a guaranteed point-in-time backup.</span></span> <span data-ttu-id="50e58-149">Exchange Online の時間差データベースコピーには可用性のしきい値があり、通常は、時間差コピーが格納されているディスクがディスク障害によって失われる時間のため、時間差コピーが、高可用性コピー (自動再生による) になることもあります。時間差データベースコピーがログ再生キューを再構築している期間。</span><span class="sxs-lookup"><span data-stu-id="50e58-149">Lagged database copies in Exchange Online have an availability threshold, typically around 90%, due to periods where the disk containing a lagged copy is lost due to disk failure, the lagged copy becoming a highly-available copy (due to automatic play down), as well as the periods where the lagged database copy is re-building the log replay queue.</span></span> 

## <a name="transport-resilience"></a><span data-ttu-id="50e58-150">トランスポートの復元性</span><span class="sxs-lookup"><span data-stu-id="50e58-150">Transport Resilience</span></span> 
<span data-ttu-id="50e58-151">Exchange Online には、シャドウ冗長とセーフティネットという2つの主要なトランスポート復元機能があります。</span><span class="sxs-lookup"><span data-stu-id="50e58-151">Exchange Online includes two primary transport resilience features: Shadow Redundancy and Safety Net.</span></span> <span data-ttu-id="50e58-152">シャドウ冗長は、送信中のメッセージの冗長コピーを保持します。</span><span class="sxs-lookup"><span data-stu-id="50e58-152">Shadow Redundancy keeps a redundant copy of a message while it is in transit.</span></span> <span data-ttu-id="50e58-153">セーフティネットは、メッセージが正常に配信された後に、メッセージの冗長コピーを保持します。</span><span class="sxs-lookup"><span data-stu-id="50e58-153">Safety Net keeps a redundant copy of a message after the message is successfully delivered.</span></span> 

<span data-ttu-id="50e58-154">シャドウ冗長性を使用すると、各 Exchange Online トランスポートサーバーは、メッセージを送信側サーバーに正常に受信することを確認する前に、受信した各メッセージのコピーを作成します。</span><span class="sxs-lookup"><span data-stu-id="50e58-154">With Shadow Redundancy, each Exchange Online transport server makes a copy of each messages it receives before it acknowledges successfully receiving the message to the sending server.</span></span> <span data-ttu-id="50e58-155">これにより、トランスポートパイプライン内のすべてのメッセージが送信中に冗長化されます。</span><span class="sxs-lookup"><span data-stu-id="50e58-155">This makes all messages in the transport pipeline redundant while in transit.</span></span> <span data-ttu-id="50e58-156">Exchange Online で送信中に元のメッセージが失われたことが確認されると、メッセージの冗長コピーが再配信されます。</span><span class="sxs-lookup"><span data-stu-id="50e58-156">If Exchange Online determines the original message was lost in transit, a redundant copy of the message is redelivered.</span></span> 

<span data-ttu-id="50e58-157">セーフティネットは、メールボックスサーバー上のトランスポートサービスに関連付けられているトランスポートキューです。</span><span class="sxs-lookup"><span data-stu-id="50e58-157">Safety Net is a transport queue that is associated with the Transport service on a Mailbox server.</span></span> <span data-ttu-id="50e58-158">このキューにより、サーバーによって正常に処理されたメッセージのコピーが保存されます。</span><span class="sxs-lookup"><span data-stu-id="50e58-158">This queue stores copies of messages that were successfully processed by the server.</span></span> <span data-ttu-id="50e58-159">メールボックスデータベースまたはサーバーの障害が、メールボックスデータベースの古いコピーをアクティブにする必要がある場合、セーフティネットキュー内のメッセージは、メールボックスデータベースの新しいアクティブコピーに自動的に再送信されます。</span><span class="sxs-lookup"><span data-stu-id="50e58-159">When a mailbox database or server failure requires activating an out-of-date copy of the mailbox database, messages in the Safety Net queue are automatically resubmitted to the new active copy of the mailbox database.</span></span> <span data-ttu-id="50e58-160">セーフティネットは冗長でもあるため、単一障害点としてのトランスポートが不要になります。</span><span class="sxs-lookup"><span data-stu-id="50e58-160">Safety Net is also redundant, thereby eliminating transport as a single point of failure.</span></span> <span data-ttu-id="50e58-161">プライマリセーフティネットとシャドウセーフティネットの概念を使用して、プライマリセーフティネットが12時間以上利用できない場合、再送信要求がシャドウ再送信要求となり、メッセージがシャドウセーフティネットから再配信される場合があります。</span><span class="sxs-lookup"><span data-stu-id="50e58-161">It uses the concept of a Primary Safety Net and a Shadow Safety Net wherein if the Primary Safety Net is unavailable for more than 12 hours, resubmit requests become shadow resubmit requests, and messages are re-delivered from the Shadow Safety Net.</span></span>

<span data-ttu-id="50e58-162">セーフティネットからのメッセージの再送信は、dag およびメールボックスデータベースコピーを管理する Microsoft Exchange Replication サービスのアクティブマネージャーコンポーネントによって自動的に開始されます。</span><span class="sxs-lookup"><span data-stu-id="50e58-162">Message resubmissions from Safety Net are automatically initiated by the Active Manager component of the Microsoft Exchange Replication service that manages DAGs and mailbox database copies.</span></span> <span data-ttu-id="50e58-163">セーフティネットからメッセージを再送信するために手動での操作は必要ありません。</span><span class="sxs-lookup"><span data-stu-id="50e58-163">No manual actions are required to resubmit messages from Safety Net.</span></span> 

## <a name="single-bit-correction"></a><span data-ttu-id="50e58-164">シングルビット修正</span><span class="sxs-lookup"><span data-stu-id="50e58-164">Single Bit Correction</span></span> 
<span data-ttu-id="50e58-165">ESE には、ハードウェアエラーの結果である単一ビット CRC エラー (つまり、1ビットフリップ) を検出して解決するメカニズムが含まれています (つまり、物理的な破損を示す)。</span><span class="sxs-lookup"><span data-stu-id="50e58-165">ESE includes a mechanism to detect and resolve single-bit CRC errors (aka single-bit flips) that are the result of hardware errors (and as such they represent physical corruption).</span></span> <span data-ttu-id="50e58-166">これらのエラーが発生すると、ESE はそれらを自動的に修正し、イベントログにイベントを記録します。</span><span class="sxs-lookup"><span data-stu-id="50e58-166">When these errors occur, ESE automatically corrects them and logs an event in the event log.</span></span> 

## <a name="online-database-scanning"></a><span data-ttu-id="50e58-167">オンラインデータベーススキャン</span><span class="sxs-lookup"><span data-stu-id="50e58-167">Online Database Scanning</span></span> 
<span data-ttu-id="50e58-168">オンラインデータベーススキャン (*データベースチェックサム*とも呼ばれます) は、ESE がデータベース整合性チェッカーを使用して各ページを読み取り、ページが破損しているかどうかを確認するプロセスです。</span><span class="sxs-lookup"><span data-stu-id="50e58-168">Online database scanning (also known as *database checksumming*) is the process where an ESE uses a database consistency checker to read each page and check for page corruption.</span></span> <span data-ttu-id="50e58-169">主な目的は、トランザクション操作によって検出されない可能性がある物理的な破損および失われたフラッシュを検出することです。</span><span class="sxs-lookup"><span data-stu-id="50e58-169">The primary purpose is to detect physical corruption and lost flushes that may not be getting detected by transactional operations.</span></span> <span data-ttu-id="50e58-170">データベーススキャンは、ストアのクラッシュ後のクラッシュ操作も実行します。</span><span class="sxs-lookup"><span data-stu-id="50e58-170">Database scanning also performs post-store crash operations.</span></span> <span data-ttu-id="50e58-171">クラッシュによって領域がリークし、オンラインデータベーススキャンによって失われた領域が検出され、回復されることがあります。</span><span class="sxs-lookup"><span data-stu-id="50e58-171">Space can be leaked due to crashes, and online database scanning finds and recovers lost space.</span></span> <span data-ttu-id="50e58-172">システムは、すべてのデータベースが7日ごとに完全にスキャンされることを想定して設計されています。</span><span class="sxs-lookup"><span data-stu-id="50e58-172">The system is designed with the expectation that every database is fully scanned once every seven days.</span></span> 

## <a name="lost-flush-detection"></a><span data-ttu-id="50e58-173">失われたフラッシュの検出</span><span class="sxs-lookup"><span data-stu-id="50e58-173">Lost Flush Detection</span></span> 
<span data-ttu-id="50e58-174">ディスクサブシステムまたはオペレーティングシステムが完了として返されたデータベース書き込み操作が実際にディスクに書き込まれなかったか、正しくない場所に書き込まれたときに、破損フラッシュが発生します。</span><span class="sxs-lookup"><span data-stu-id="50e58-174">A lost flush occurs when a database write operation that the disk subsystem/operating system returned as completed did not actually get written to disk, or was written in the wrong location.</span></span> <span data-ttu-id="50e58-175">失われたフラッシュインシデントはデータベースの論理的な破損につながる可能性があるため、データの損失を回避するために、ESE に失われたフラッシュ検出メカニズムが用意されています。</span><span class="sxs-lookup"><span data-stu-id="50e58-175">Lost flush incidents can result in database logical corruption, so to prevent lost flushes from resulting in lost data, ESE includes a lost flush detection mechanism.</span></span> <span data-ttu-id="50e58-176">データベースページがパッシブコピーに書き込まれると、アクティブコピーの失われたフラッシュに対してチェックが実行されます。</span><span class="sxs-lookup"><span data-stu-id="50e58-176">As database pages are written to passive copies, a check is performed for lost flushes on the active copy.</span></span> <span data-ttu-id="50e58-177">失われたフラッシュが検出されると、ESE はページパッチ処理を使用してプロセスを修復できます。</span><span class="sxs-lookup"><span data-stu-id="50e58-177">If a lost flush is detected, ESE can repair the process using a page patching process.</span></span> 

## <a name="single-page-restore"></a><span data-ttu-id="50e58-178">単一ページの復元</span><span class="sxs-lookup"><span data-stu-id="50e58-178">Single Page Restore</span></span> 
<span data-ttu-id="50e58-179">単一ページの復元、つまり*ページパッチ*は、破損したデータベースページが正常なレプリカからの正常なコピーに置き換えられる自動プロセスです。</span><span class="sxs-lookup"><span data-stu-id="50e58-179">Single page restore, aka *page patching*, is an automatic process where corrupt database pages are replaced by healthy copies from a healthy replica.</span></span> <span data-ttu-id="50e58-180">破損したページの修復プロセスは、データベースコピーがアクティブであるかパッシブであるかによって異なります。</span><span class="sxs-lookup"><span data-stu-id="50e58-180">The repair process for a corrupt page depends on whether the database copy is active or passive.</span></span> <span data-ttu-id="50e58-181">アクティブなデータベースコピーは、破損したページを検出すると、ページが完全に最新の状態になっていれば、そのレプリカの1つからページをコピーできます。</span><span class="sxs-lookup"><span data-stu-id="50e58-181">When an active database copy encounters a corrupted page, it can copy a page from one of its replicas, provided the page it copies is completely up-to-date.</span></span> <span data-ttu-id="50e58-182">これは、ページの要求をログストリームに配置することによって実現されます。これは、メールボックスデータベースのレプリケーションの基礎となります。</span><span class="sxs-lookup"><span data-stu-id="50e58-182">This is accomplished by putting a request for the page into the log stream, which is the basis of mailbox database replication.</span></span> <span data-ttu-id="50e58-183">レプリカがページ要求を検出するとすぐに、要求元のデータベースコピーにページのコピーを送信することによって応答します。</span><span class="sxs-lookup"><span data-stu-id="50e58-183">As soon as a replica encounters the page request it responds by sending a copy of the page to the requesting database copy.</span></span> <span data-ttu-id="50e58-184">また、単一ページの復元では、レプリカが現在オフラインであっても、レプリカからページを要求するためにアクティブな非同期通信メカニズムも提供されます。</span><span class="sxs-lookup"><span data-stu-id="50e58-184">Single page restore also provides an asynchronous communication mechanism for the active to request a page from replicas, even if the replicas are currently offline.</span></span> 

<span data-ttu-id="50e58-185">時間差データベースコピーを含むパッシブデータベースコピーが破損した場合、これらのコピーは常にアクティブコピーの背後にあるため、アクティブコピーからパッシブコピーに任意のページをコピーするのは常に安全です。</span><span class="sxs-lookup"><span data-stu-id="50e58-185">In case of corruption in a passive database copy, including a lagged database copy, because these copies are always behind their active copy, it is always safe to copy any page from the active copy to a passive copy.</span></span> <span data-ttu-id="50e58-186">パッシブデータベースコピーは自然に高可用性のため、ページのパッチ処理中にログの再生は中断されますが、ログのコピーは続行されます。</span><span class="sxs-lookup"><span data-stu-id="50e58-186">A passive database copy is by nature highly available, so during the page patching process, log replaying is suspended, but log copying continues.</span></span> <span data-ttu-id="50e58-187">パッシブデータベースコピーは、アクティブなコピーから破損したページのコピーを取得し、ログ生成に必要な最大要件を満たすログファイルがコピーおよび検査されるまで待機してから、破損したページを更新します。</span><span class="sxs-lookup"><span data-stu-id="50e58-187">The passive database copy retrieves a copy of the corrupted page from the active copy, waits until the log file which meets the maximum required log generation requirement is copied and inspected, and then patches the corrupt page.</span></span> <span data-ttu-id="50e58-188">ページにパッチが適用されると、ログ再生が再開します。</span><span class="sxs-lookup"><span data-stu-id="50e58-188">Once the page has been patched, log replay resumes.</span></span> <span data-ttu-id="50e58-189">このプロセスは、時間差データベースコピーの場合と同じですが、時間差データベースは、最初に patchable 状態を実現するために必要なすべてのログファイルを再生する点が異なります。</span><span class="sxs-lookup"><span data-stu-id="50e58-189">The process is the same for the lagged database copy, except that the lagged database first replays all log files that are necessary to achieve a patchable state.</span></span> 

## <a name="mailbox-replication-service"></a><span data-ttu-id="50e58-190">メールボックスレプリケーションサービス</span><span class="sxs-lookup"><span data-stu-id="50e58-190">Mailbox Replication Service</span></span> 
<span data-ttu-id="50e58-191">メールボックスの移動は、大規模なメールサービスを管理するための重要な部分です。</span><span class="sxs-lookup"><span data-stu-id="50e58-191">Moving mailboxes is a key part of managing a large-scale email service.</span></span> <span data-ttu-id="50e58-192">常に更新されたテクノロジとハードウェアおよびバージョンのアップグレードがあります。これにより、エンジニアがこの作業を行い、メールボックスの移動をユーザーに対して透過的に行うことができます (オンライン状態が維持されていることを確認してください)。プロセス全体) は重要であり、メールボックスのサイズが大きくなるにつれて、プロセスが適切に拡張されるようにすることが重要です。</span><span class="sxs-lookup"><span data-stu-id="50e58-192">There are always updated technologies and hardware and version upgrades to deal with, so having a robust, throttled system that enables our engineers to accomplish this work while keeping the mailbox moves transparent to users (by making sure they stay online throughout the process) is key and making sure that the process scales up gracefully as mailboxes get larger and larger.</span></span> 

<span data-ttu-id="50e58-193">Exchange メールボックスレプリケーションサービス (mr) は、データベース間でメールボックスを移動する役割を担います。</span><span class="sxs-lookup"><span data-stu-id="50e58-193">The Exchange Mailbox Replication Service (MRS) is responsible for moving mailboxes between databases.</span></span> <span data-ttu-id="50e58-194">移行中、mr はメールボックス内のすべてのアイテムに対して整合性チェックを実行します。</span><span class="sxs-lookup"><span data-stu-id="50e58-194">During the move, MRS performs a consistency check on all items within the mailbox.</span></span> <span data-ttu-id="50e58-195">整合性の問題が検出された場合は、問題を解決するか、破損したアイテムをスキップして、メールボックスの破損を回避することができます。</span><span class="sxs-lookup"><span data-stu-id="50e58-195">If a consistency issue is found, MRS will either correct the problem, or skip the corrupted items, thereby removing the corruption from the mailbox.</span></span> 

<span data-ttu-id="50e58-196">お客様は、お客様が Exchange Online のコンポーネントであるため、今後検出される新しい形式の破損に対処するために、コードに変更を加えることができます。</span><span class="sxs-lookup"><span data-stu-id="50e58-196">Because MRS is a component of Exchange Online, we can make changes in its code to address new forms of corruption that are detected in the future.</span></span> <span data-ttu-id="50e58-197">たとえば、問題を解決できないという一貫性の問題が検出された場合は、破損を分析し、mr コードを変更して、矛盾を修正します (方法を理解している場合)。</span><span class="sxs-lookup"><span data-stu-id="50e58-197">For example, if we detect a consistency issue that MRS is not able to fix, we can analyze the corruption, change the MRS code and correct the inconsistency (if we understand how to).</span></span> 

## <a name="log-file-checks"></a><span data-ttu-id="50e58-198">ログファイルのチェック</span><span class="sxs-lookup"><span data-stu-id="50e58-198">Log File Checks</span></span> 
<span data-ttu-id="50e58-199">Exchange データベースによって生成されたすべてのトランザクションログファイルには、いくつかの形式の整合性チェックが行われます。</span><span class="sxs-lookup"><span data-stu-id="50e58-199">All transaction log files generated by an Exchange database undergo several forms of consistency checks.</span></span> <span data-ttu-id="50e58-200">ログファイルが作成されると、最初に行うことはビットパターンを作成してから、一連のログ書き込みを実行するということです。</span><span class="sxs-lookup"><span data-stu-id="50e58-200">When a log file is created, the first thing done is a bit pattern is written and then a series of log writes is performed.</span></span> <span data-ttu-id="50e58-201">これにより、Exchange Online は一連のチェック (失われたフラッシュ、CRC、その他のチェック) を実行して、書き込まれた各ログファイルを検証したり、複製したりします。</span><span class="sxs-lookup"><span data-stu-id="50e58-201">This enables Exchange Online to execute a series of checks (lost flush, CRC and other checks) to validate each log file as it is written, and again as it is replicated.</span></span> 

## <a name="deployment-on-resilient-file-system"></a><span data-ttu-id="50e58-202">弾性ファイルシステムへの展開</span><span class="sxs-lookup"><span data-stu-id="50e58-202">Deployment on Resilient File System</span></span> 
<span data-ttu-id="50e58-203">ファイルシステムレベルで破損が発生しないようにするために、Exchange Online は回復機能を強化するために、復元可能なファイルシステム (ReFS) パーティションに展開されています。</span><span class="sxs-lookup"><span data-stu-id="50e58-203">To help prevent corruption from occurring at the file system level, Exchange Online is being deployed on Resilient File System (ReFS) partitions to provide improved recovery capabilities.</span></span> <span data-ttu-id="50e58-204">ReFS は、データ破損に対する復元性を向上させるために設計された Windows Server 2012 以降のファイルシステムで、データの可用性と整合性を最大限に高めます。</span><span class="sxs-lookup"><span data-stu-id="50e58-204">ReFS is a file system in Windows Server 2012 and later that is designed to be more resilient against data corruption thereby maximizing data availability and integrity.</span></span> <span data-ttu-id="50e58-205">具体的には、メタデータの更新方法が向上し、データの保護が向上し、データ破損のケースが減少します。</span><span class="sxs-lookup"><span data-stu-id="50e58-205">Specifically, ReFS brings improvements in the way that metadata is updated which offers better protection for data and reduces data corruption cases.</span></span> <span data-ttu-id="50e58-206">また、チェックサムを使用して、ファイルデータの整合性と、データの破損が容易に検出および修復されることを確認します。</span><span class="sxs-lookup"><span data-stu-id="50e58-206">It also uses checksums to verify the integrity of file data and metadata ensuring that data corruption is easily found and repaired.</span></span> 

<span data-ttu-id="50e58-207">Exchange Online は、次に示すいくつかの参照の利点を活用しています。</span><span class="sxs-lookup"><span data-stu-id="50e58-207">Exchange Online takes advantage of several ReFS benefits:</span></span> 
- <span data-ttu-id="50e58-208">データ整合性の復元性が向上すると、データ破損インシデントが減少します。</span><span class="sxs-lookup"><span data-stu-id="50e58-208">More resiliency in data integrity means fewer data corruption incidents.</span></span> <span data-ttu-id="50e58-209">破損インシデントの数を減らすと、不要なデータベースの再シードが減少します。</span><span class="sxs-lookup"><span data-stu-id="50e58-209">Reducing the number of corruption incidents means fewer unnecessary database reseeds.</span></span> 
- <span data-ttu-id="50e58-210">メタデータで実行されているチェックサムにより、破損のケースをより早く検出できるようになり、データボリュームでグレイエラーが発生する前に、顧客データの破損を修正できるようになります。</span><span class="sxs-lookup"><span data-stu-id="50e58-210">Checksum running on metadata enabling detections of corruption cases sooner and more deterministically, allowing us to fix customer data corruption before grey failures occur on data volumes.</span></span>
- <span data-ttu-id="50e58-211">パフォーマンスに影響を与えることなく、非常に大規模なデータセット (ペタバイト以上) で正常に動作するように設計されている</span><span class="sxs-lookup"><span data-stu-id="50e58-211">Designed to work well with extremely large data sets—petabytes and larger—without performance impact</span></span>
- <span data-ttu-id="50e58-212">Exchange Online で使用されるその他の機能のサポート (BitLocker 暗号化など)。</span><span class="sxs-lookup"><span data-stu-id="50e58-212">Support for other features used by Exchange Online, such as BitLocker encryption.</span></span> 

<span data-ttu-id="50e58-213">Exchange Online には、他の ReFS 機能によるメリットもあります。</span><span class="sxs-lookup"><span data-stu-id="50e58-213">Exchange Online also benefits from other ReFS features:</span></span> 
- <span data-ttu-id="50e58-214">**整合性 (整合性ストリーム)** -ReFS は、通常、データ損失が発生する多くの一般的なエラーからデータを保護する方法でデータを格納します。</span><span class="sxs-lookup"><span data-stu-id="50e58-214">**Integrity (Integrity Streams)** - ReFS stores data in a way that protects it from many of the common errors that can normally cause data loss.</span></span> <span data-ttu-id="50e58-215">Office 365 検索は、整合性ストリームを使用して、ファイルコンテンツの早期のディスク破損検出とチェックサムを支援します。</span><span class="sxs-lookup"><span data-stu-id="50e58-215">Office 365 Search uses Integrity Streams to help with early disk corruption detection and checksums of file content.</span></span> <span data-ttu-id="50e58-216">また、この機能により、"欠落書き込み" によって発生する破損インシデントが減少します (停電などのために書き込み操作が完了しなかった場合)。</span><span class="sxs-lookup"><span data-stu-id="50e58-216">The feature also reduces corruption incidents caused by “Torn Writes” (when a write operation does not complete due to power outages, etc.).</span></span> 
- <span data-ttu-id="50e58-217">**availability (Salvage)** -ReFS は、データの可用性の優先順位を示します。</span><span class="sxs-lookup"><span data-stu-id="50e58-217">**Availability (Salvage)** - ReFS prioritizes the availability of data.</span></span> <span data-ttu-id="50e58-218">従来は、ファイルシステムがデータ破損の影響を受けやすくなり、修復のためにシステムをオフラインにする必要がありました。</span><span class="sxs-lookup"><span data-stu-id="50e58-218">Historically, file systems were often susceptible to data corruption that would require the system to be taken offline for repair.</span></span> <span data-ttu-id="50e58-219">まれに破損が発生した場合、ReFS は salvage を実装します。この機能は、ライブボリューム上の名前空間から破損したデータを削除し、修復できない破損データによって良好なデータが悪影響を受けないようにする機能です。</span><span class="sxs-lookup"><span data-stu-id="50e58-219">Although rare, if corruption does occur, ReFS implements salvage, a feature that removes the corrupt data from the namespace on a live volume and ensures that good data is not adversely affected by non-repairable corrupt data.</span></span> <span data-ttu-id="50e58-220">Salvage 機能を適用し、データ破損を Exchange Online データベースボリュームに分離することは、破損した状態と修復処理の間に影響を受けないデータベースを破損したボリュームに保持できることを意味します。</span><span class="sxs-lookup"><span data-stu-id="50e58-220">Applying the Salvage feature and isolating data corruption to Exchange Online database volumes means that we can keep non-affected databases on a corrupted volume healthy between the time of corruption and repair action.</span></span> <span data-ttu-id="50e58-221">これにより、通常はディスク破損の問題の影響を受けるデータベースの可用性が向上します。</span><span class="sxs-lookup"><span data-stu-id="50e58-221">This increases the availability of databases that would normally be affected by such disk corruption issues.</span></span> 